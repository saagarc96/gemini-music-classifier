// Prisma Schema for Music Classification Review Interface
// This defines the database structure for storing songs and AI classifications

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_URL_NON_POOLING") // Direct connection for local dev
  directUrl = env("POSTGRES_URL_NON_POOLING") // Uses direct connection for migrations
}

// User authentication and roles
model User {
  id           String   @id @default(cuid())
  email        String   @unique @db.VarChar(255)
  passwordHash String   @map("password_hash")
  name         String   @db.VarChar(255)
  role         Role     @default(CURATOR)
  active       Boolean  @default(true)
  createdAt    DateTime @default(now()) @map("created_at")
  lastLoginAt  DateTime? @map("last_login_at")

  // Relations
  reviewedSongs Song[] @relation("ReviewedBy")
  createdSongs  Song[] @relation("CreatedBy")

  @@map("users")
}

enum Role {
  ADMIN
  CURATOR
}

model Song {
  id       Int    @id @default(autoincrement())
  isrc     String @unique @db.VarChar(12)

  // Original CSV metadata
  title       String?
  artist      String?
  energy      String? @db.VarChar(20)
  bpm         Int?
  subgenre    String?
  artwork     String?
  sourceFile  String? @map("source_file")

  // Media URLs
  s3Url               String? @map("s3_url")
  artworkUrl          String? @map("artwork_url")

  // Spotify integration
  spotifyTrackId      String? @map("spotify_track_id") @db.VarChar(50)
  spotifyPreviewUrl   String? @map("spotify_preview_url")
  spotifyArtworkUrl   String? @map("spotify_artwork_url")

  // AI classifications (editable by curators)
  aiStatus        String? @map("ai_status") @db.VarChar(50)
  aiErrorMessage  String? @map("ai_error_message")
  aiReasoning     String? @map("ai_reasoning")
  aiContextUsed   String? @map("ai_context_used")
  aiEnergy        String? @map("ai_energy") @db.VarChar(20)
  aiAccessibility String? @map("ai_accessibility") @db.VarChar(20)
  aiExplicit      String? @map("ai_explicit") @db.VarChar(20)
  aiSubgenre1     String? @map("ai_subgenre_1") @db.VarChar(100)
  aiSubgenre2     String? @map("ai_subgenre_2") @db.VarChar(100)
  aiSubgenre3     String? @map("ai_subgenre_3") @db.VarChar(100)

  // Review metadata
  reviewed     Boolean   @default(false)
  reviewedBy   String?   @map("reviewed_by") @db.VarChar(100)
  reviewedById String?   @map("reviewed_by_id")
  reviewer     User?     @relation("ReviewedBy", fields: [reviewedById], references: [id], onDelete: SetNull)
  reviewedAt   DateTime? @map("reviewed_at")
  curatorNotes String?   @map("curator_notes")

  // Creator tracking
  createdById  String?   @map("created_by_id")
  creator      User?     @relation("CreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  // Duplicate tracking
  isDuplicate   Boolean  @default(false) @map("is_duplicate")
  originalIsrc  String?  @map("original_isrc") @db.VarChar(12)
  uploadBatchId String?  @map("upload_batch_id") @db.VarChar(50)

  // Timestamps
  createdAt  DateTime @default(now()) @map("created_at")
  modifiedAt DateTime @default(now()) @updatedAt @map("modified_at")

  @@index([isrc])
  @@index([aiSubgenre1], map: "idx_subgenre_1")
  @@index([aiSubgenre2], map: "idx_subgenre_2")
  @@index([aiSubgenre3], map: "idx_subgenre_3")
  @@index([aiStatus], map: "idx_status")
  @@index([reviewed])
  @@index([spotifyTrackId], map: "idx_spotify_track_id")
  @@index([reviewedById], map: "idx_reviewed_by_id")
  @@index([createdById], map: "idx_created_by_id")
  @@index([isDuplicate], map: "idx_is_duplicate")
  @@index([originalIsrc], map: "idx_original_isrc")
  @@index([uploadBatchId], map: "idx_upload_batch_id")
  @@map("songs")
}
